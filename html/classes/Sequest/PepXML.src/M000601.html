<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>set_from_bioworks_xml (Sequest::PepXML)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File lib/spec_id/sequest/pepxml.rb, line 527</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">set_from_bioworks_xml</span>(<span class="ruby-identifier">bioworks</span>, <span class="ruby-identifier">params</span>, <span class="ruby-identifier">opts</span>={})
    <span class="ruby-identifier">opts</span> = <span class="ruby-constant">Default_Options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">opts</span>)
    <span class="ruby-identifier">pepxml_version</span>, <span class="ruby-identifier">ms_manufacturer</span>, <span class="ruby-identifier">ms_model</span>, <span class="ruby-identifier">ms_ionization</span>, <span class="ruby-identifier">ms_mass_analyzer</span>, <span class="ruby-identifier">ms_detector</span>, <span class="ruby-identifier">raw_data_type</span>, <span class="ruby-identifier">raw_data</span>, <span class="ruby-identifier">out_data_type</span>, <span class="ruby-identifier">out_data</span>, <span class="ruby-identifier">ms_data</span>, <span class="ruby-identifier">out_path</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-identifier">:pepxml_version</span>, <span class="ruby-identifier">:ms_manufacturer</span>, <span class="ruby-identifier">:ms_model</span>, <span class="ruby-identifier">:ms_ionization</span>, <span class="ruby-identifier">:ms_mass_analyzer</span>, <span class="ruby-identifier">:ms_detector</span>, <span class="ruby-identifier">:raw_data_type</span>, <span class="ruby-identifier">:raw_data</span>, <span class="ruby-identifier">:out_data_type</span>, <span class="ruby-identifier">:out_data</span>, <span class="ruby-identifier">:ms_data</span>, <span class="ruby-identifier">:out_path</span>)



    <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">out_path</span>
      <span class="ruby-identifier">out_path</span> = <span class="ruby-value str">'.'</span>
    <span class="ruby-keyword kw">end</span>

    <span class="ruby-identifier">supported_versions</span> = [<span class="ruby-value">18</span>]

    <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">supported_versions</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:pepxml_version</span>]) 
      <span class="ruby-identifier">abort</span> <span class="ruby-node">&quot;pepxml_version: #{pepxml_version} not currently supported.  Current support is for versions #{supported_versions.join(', ')}&quot;</span>
    <span class="ruby-keyword kw">end</span>

    <span class="ruby-comment cmt">## Turn params and bioworks_obj into objects if necessary:</span>
    <span class="ruby-comment cmt"># Params:</span>
    <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">Params</span>  <span class="ruby-comment cmt"># OK!</span>
    <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span> ; <span class="ruby-identifier">params</span> = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">Params</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>)
    <span class="ruby-keyword kw">else</span>                         ; <span class="ruby-identifier">abort</span> <span class="ruby-node">&quot;Don't recognize #{params} as object or string!&quot;</span>
    <span class="ruby-keyword kw">end</span>
    <span class="ruby-comment cmt"># Bioworks:</span>
    <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">bioworks</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Bioworks</span>  <span class="ruby-comment cmt"># OK!</span>
    <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">bioworks</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span> ; <span class="ruby-identifier">bioworks</span> = <span class="ruby-constant">SpecID</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bioworks</span>)
    <span class="ruby-keyword kw">else</span>                           ; <span class="ruby-identifier">abort</span> <span class="ruby-node">&quot;Don't recognize #{bioworks} as object or string!&quot;</span>
    <span class="ruby-keyword kw">end</span>

    <span class="ruby-identifier">sample_enzyme_obj</span> = 
      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:sample_enzyme</span>]
        <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:sample_enzyme</span>]
      <span class="ruby-keyword kw">else</span>
        <span class="ruby-identifier">params</span>.<span class="ruby-identifier">sample_enzyme</span>
      <span class="ruby-keyword kw">end</span>

    <span class="ruby-comment cmt">#puts &quot;bioworks.peps.size: #{bioworks.peps.size}&quot;; #puts &quot;bioworks.prots.size: #{bioworks.prots.size}&quot;; #puts &quot;Bioworks.version: #{bioworks.version}&quot;</span>

    <span class="ruby-comment cmt">## TURN THIS ON IF YOU THINK YOU MIGHT NOT BE GETTING PEPTIDES from</span>
    <span class="ruby-comment cmt">## bioworks</span>
    <span class="ruby-comment cmt">#bioworks.peps.each { |pep| if pep.class != Bioworks::Pep ; puts &quot;trying to pass as pep: &quot;; p pep; abort &quot;NOT a pep!&quot; end }</span>

    <span class="ruby-comment cmt">## check to see if we need backup_db</span>

    <span class="ruby-identifier">backup_db_path</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:backup_db_path</span>)
    <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">params</span>.<span class="ruby-identifier">database</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">backup_db_path</span>
      <span class="ruby-identifier">params</span>.<span class="ruby-identifier">database_path</span> = <span class="ruby-identifier">backup_db_path</span>
    <span class="ruby-keyword kw">end</span>

    <span class="ruby-comment cmt">## Start</span>
    <span class="ruby-identifier">split_bio_objs</span> = []

    <span class="ruby-comment cmt">## (num_prots_by_pep, prot_by_pep) = </span>
    <span class="ruby-comment cmt">#num_prots_by_pep.each do |k,v| puts &quot;k: #{k} v: #{v}\n&quot;; break end ; prot_by_pep.each do |k,v| puts &quot;k: #{k} v: #{v}&quot; ; break end ; abort &quot;HERE&quot;</span>

    <span class="ruby-identifier">modifications_string</span> = <span class="ruby-identifier">bioworks</span>.<span class="ruby-identifier">modifications</span>

    <span class="ruby-comment cmt">## Create a hash of spectrum_query arrays by filename (this very big block):</span>
    <span class="ruby-identifier">spectrum_queries_by_base_name</span> = {}
    <span class="ruby-comment cmt"># Hash by the filenames to split into filenames:</span>
    <span class="ruby-identifier">pepxml_objects</span> = <span class="ruby-identifier">bioworks</span>.<span class="ruby-identifier">peps</span>.<span class="ruby-identifier">hash_by</span>(<span class="ruby-identifier">:base_name</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">base_name</span>, <span class="ruby-identifier">pep_arr</span><span class="ruby-operator">|</span>

      <span class="ruby-identifier">search_summary</span> = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">SearchSummary</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>, <span class="ruby-identifier">modifications_string</span>, {<span class="ruby-identifier">:search_database</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">SearchDatabase</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>), <span class="ruby-identifier">:out_data_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">out_data_type</span>, <span class="ruby-identifier">:out_data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">out_data</span>})
      <span class="ruby-identifier">modifications_obj</span> = <span class="ruby-identifier">search_summary</span>.<span class="ruby-identifier">modifications</span>

      <span class="ruby-identifier">pepxml_obj</span> = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pepxml_version</span>, <span class="ruby-identifier">params</span>)
      <span class="ruby-identifier">full_base_name_no_ext</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">make_base_name</span>( <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">out_path</span>), <span class="ruby-identifier">base_name</span>)

      <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">pepxml_version</span>
      <span class="ruby-keyword kw">when</span> <span class="ruby-value">18</span>
        <span class="ruby-identifier">pipeline</span> =  <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">MSMSPipelineAnalysis</span>.<span class="ruby-identifier">new</span>({<span class="ruby-identifier">:date=</span><span class="ruby-operator">&gt;</span><span class="ruby-keyword kw">nil</span>,<span class="ruby-identifier">:summary_xml=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">base_name</span><span class="ruby-operator">+</span><span class="ruby-value str">'.xml'</span>})
        <span class="ruby-identifier">msms_run_summary</span> = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">MSMSRunSummary</span>.<span class="ruby-identifier">new</span>({
          <span class="ruby-identifier">:base_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">full_base_name_no_ext</span>,
          <span class="ruby-identifier">:ms_manufacturer</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ms_manufacturer</span>,
          <span class="ruby-identifier">:ms_model</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ms_model</span>,
          <span class="ruby-identifier">:ms_ionization</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ms_ionization</span>,
          <span class="ruby-identifier">:ms_mass_analyzer</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ms_mass_analyzer</span>,
          <span class="ruby-identifier">:ms_detector</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ms_detector</span>,
          <span class="ruby-identifier">:raw_data_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">raw_data_type</span>,
          <span class="ruby-identifier">:raw_data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">raw_data</span>,
          <span class="ruby-identifier">:sample_enzyme</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sample_enzyme_obj</span>, <span class="ruby-comment cmt"># usually, params.sample_enzyme,</span>
          <span class="ruby-identifier">:search_summary</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">search_summary</span>,
        }) 
        <span class="ruby-identifier">pipeline</span>.<span class="ruby-identifier">msms_run_summary</span> = <span class="ruby-identifier">msms_run_summary</span>
        <span class="ruby-identifier">pepxml_obj</span>.<span class="ruby-identifier">msms_pipeline_analysis</span> = <span class="ruby-identifier">pipeline</span>
        <span class="ruby-identifier">pepxml_obj</span>.<span class="ruby-identifier">msms_pipeline_analysis</span>.<span class="ruby-identifier">msms_run_summary</span>.<span class="ruby-identifier">search_summary</span>.<span class="ruby-identifier">base_name</span> =  <span class="ruby-identifier">full_base_name_no_ext</span>
        <span class="ruby-identifier">pepxml_obj</span>.<span class="ruby-identifier">base_name</span> = <span class="ruby-identifier">full_base_name_no_ext</span>
        <span class="ruby-identifier">pepxml_obj</span> 
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-comment cmt"># Create a hash by pep object containing num_tot_proteins</span>
      <span class="ruby-comment cmt"># This is only valid if all hits are present (no previous thresholding)</span>
      <span class="ruby-comment cmt"># Since out2summary only acts on one folder at a time,</span>
      <span class="ruby-comment cmt"># we should only do it for one folder at a time! (that's why we do this</span>
      <span class="ruby-comment cmt"># here instead of globally)</span>
      <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">_prot_num_and_first_prot_by_pep</span>(<span class="ruby-identifier">pep_arr</span>)
      <span class="ruby-identifier">prec_mz_arr</span> = <span class="ruby-keyword kw">nil</span>
      <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">x</span> = <span class="ruby-identifier">bioworks</span>.<span class="ruby-identifier">version</span>
      <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/3.2/</span> 
        <span class="ruby-identifier">calc_prec_by</span> = <span class="ruby-identifier">:prec_mz_arr</span>
        <span class="ruby-comment cmt"># get the precursor_mz array for this filename</span>
        <span class="ruby-identifier">mzxml_file</span> = <span class="ruby-constant">MS</span><span class="ruby-operator">::</span><span class="ruby-constant">Converter</span><span class="ruby-operator">::</span><span class="ruby-constant">MzXML</span>.<span class="ruby-identifier">file_to_mzxml</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">ms_data</span>, <span class="ruby-identifier">base_name</span>))
        <span class="ruby-identifier">prec_mz_arr</span> = <span class="ruby-constant">MS</span><span class="ruby-operator">::</span><span class="ruby-constant">MSRun</span>.<span class="ruby-identifier">precursor_mz_by_scan_num</span>(<span class="ruby-identifier">mzxml_file</span>)
      <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/3.3/</span>
        <span class="ruby-identifier">calc_prec_by</span> = <span class="ruby-identifier">:deltamass</span>
      <span class="ruby-keyword kw">else</span>
        <span class="ruby-identifier">abort</span> <span class="ruby-node">&quot;invalid BioworksBrowser version: #{x}&quot;</span>
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:copy_mzxml</span>]
        <span class="ruby-identifier">to_copy</span> = <span class="ruby-constant">MS</span><span class="ruby-operator">::</span><span class="ruby-constant">Converter</span><span class="ruby-operator">::</span><span class="ruby-constant">MzXML</span>.<span class="ruby-identifier">file_to_mzxml</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">ms_data</span>, <span class="ruby-identifier">base_name</span>))
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">to_copy</span>
          <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">cp</span> <span class="ruby-identifier">to_copy</span>, <span class="ruby-identifier">out_path</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span>


      <span class="ruby-identifier">spectrum_queries_ar</span> = <span class="ruby-identifier">pep_arr</span>.<span class="ruby-identifier">hash_by</span>(<span class="ruby-identifier">:first_scan</span>, <span class="ruby-identifier">:last_scan</span>, <span class="ruby-identifier">:charge</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>,<span class="ruby-identifier">arr</span><span class="ruby-operator">|</span>


        <span class="ruby-comment cmt"># Sort_by_rank and take the top hit (to mimick out2summary):</span>

        <span class="ruby-identifier">arr</span> = <span class="ruby-identifier">arr</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">pep</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pep</span>.<span class="ruby-identifier">xcorr</span>.<span class="ruby-identifier">to_f</span> } <span class="ruby-comment cmt"># ascending</span>
        <span class="ruby-identifier">top_pep</span> = <span class="ruby-identifier">arr</span>.<span class="ruby-identifier">pop</span>
        <span class="ruby-identifier">second_hit</span> = <span class="ruby-identifier">arr</span>.<span class="ruby-identifier">last</span> <span class="ruby-comment cmt"># needed for deltacnstar</span>


        <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">calc_prec_by</span>
        <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:prec_mz_arr</span>
          <span class="ruby-identifier">precursor_neutral_mass</span> = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">SpectrumQuery</span>.<span class="ruby-identifier">calc_precursor_neutral_mass</span>(<span class="ruby-identifier">calc_prec_by</span>, <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">first_scan</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">last_scan</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">prec_mz_arr</span>, <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">charge</span>, <span class="ruby-identifier">pepxml_obj</span>.<span class="ruby-identifier">avg_parent</span>)
        <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:deltamass</span>
          <span class="ruby-identifier">precursor_neutral_mass</span> = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">SpectrumQuery</span>.<span class="ruby-identifier">calc_precursor_neutral_mass</span>(<span class="ruby-identifier">calc_prec_by</span>, <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">mass</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">deltamass</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-identifier">pepxml_obj</span>.<span class="ruby-identifier">avg_parent</span>)
        <span class="ruby-keyword kw">end</span>

        <span class="ruby-identifier">calc_neutral_pep_mass</span> = (<span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">mass</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">pepxml_obj</span>.<span class="ruby-identifier">h_plus</span>)

        <span class="ruby-comment cmt"># deltacn &amp; star:</span>
        <span class="ruby-comment cmt"># (NOTE: OLD?? out2summary wants the deltacn of the 2nd best hit.)</span>
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">second_hit</span> 
          <span class="ruby-comment cmt">#top_pep.deltacn = second_hit.deltacn </span>
          <span class="ruby-identifier">deltacnstar</span> = <span class="ruby-value str">'0'</span>
        <span class="ruby-keyword kw">else</span> 
          <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">deltacn</span> = <span class="ruby-value str">'1.0'</span>
          <span class="ruby-identifier">deltacnstar</span> = <span class="ruby-value str">'1'</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-comment cmt"># Create the nested structure of queries{results{hits}}</span>
        <span class="ruby-comment cmt"># (Ruby's blocks work beautifully for things like this)</span>
        <span class="ruby-identifier">spec_query</span> = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">SpectrumQuery</span>.<span class="ruby-identifier">new</span>({
          <span class="ruby-identifier">:spectrum</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">base_name</span>, <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">first_scan</span>, <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">last_scan</span>, <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">charge</span>].<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;.&quot;</span>),
          <span class="ruby-identifier">:start_scan</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">first_scan</span>,
          <span class="ruby-identifier">:end_scan</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">last_scan</span>,
          <span class="ruby-identifier">:precursor_neutral_mass</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">precursor_neutral_mass</span>,
          <span class="ruby-identifier">:assumed_charge</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">charge</span>,
          <span class="ruby-identifier">:pepxml_version</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pepxml_version</span>,
        }) 


        <span class="ruby-identifier">search_result</span> = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">SearchResult</span>.<span class="ruby-identifier">new</span> 
        <span class="ruby-comment cmt">#puts &quot;set MASSDIFF: &quot;</span>
        <span class="ruby-comment cmt">#p precursor_neutral_mass - calc_neutral_pep_mass</span>
        <span class="ruby-comment cmt">## Calculate some interdependent values;</span>
        <span class="ruby-comment cmt"># NOTE: the bioworks mass is reallyf M+H if two or more scans went</span>
        <span class="ruby-comment cmt"># into the search_hit; calc_neutral_pep_mass is simply the avg of</span>
        <span class="ruby-comment cmt"># precursor masses adjusted to be neutral</span>
        (<span class="ruby-identifier">prevaa</span>, <span class="ruby-identifier">pepseq</span>, <span class="ruby-identifier">nextaa</span>) = <span class="ruby-constant">SpecID</span><span class="ruby-operator">::</span><span class="ruby-constant">Pep</span>.<span class="ruby-identifier">prepare_sequence</span>(<span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">sequence</span>)
        (<span class="ruby-identifier">num_matched_ions</span>, <span class="ruby-identifier">tot_num_ions</span>) = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">SearchHit</span>.<span class="ruby-identifier">split_ions</span>(<span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">ions</span>)
        <span class="ruby-identifier">search_hit</span> = <span class="ruby-constant">Sequest</span><span class="ruby-operator">::</span><span class="ruby-constant">PepXML</span><span class="ruby-operator">::</span><span class="ruby-constant">SearchHit</span>.<span class="ruby-identifier">new</span>({
          <span class="ruby-identifier">:hit_rank</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,
          <span class="ruby-identifier">:peptide</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pepseq</span>,
          <span class="ruby-identifier">:peptide_prev_aa</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">prevaa</span>,
          <span class="ruby-identifier">:peptide_next_aa</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">nextaa</span>,
          <span class="ruby-identifier">:protein</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">_first_prot</span>.<span class="ruby-identifier">reference</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot; &quot;</span>).<span class="ruby-identifier">first</span>, 
          <span class="ruby-identifier">:num_tot_proteins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">_num_prots</span>,
          <span class="ruby-identifier">:num_matched_ions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">num_matched_ions</span>,
          <span class="ruby-identifier">:tot_num_ions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tot_num_ions</span>,
          <span class="ruby-identifier">:calc_neutral_pep_mass</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">calc_neutral_pep_mass</span>,
          <span class="ruby-identifier">:massdiff</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">precursor_neutral_mass</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">calc_neutral_pep_mass</span>,
          <span class="ruby-identifier">:num_tol_term</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sample_enzyme_obj</span>.<span class="ruby-identifier">num_tol_term</span>(<span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">sequence</span>),
          <span class="ruby-identifier">:num_missed_cleavages</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">sample_enzyme_obj</span>.<span class="ruby-identifier">num_missed_cleavages</span>(<span class="ruby-identifier">pepseq</span>),
          <span class="ruby-identifier">:is_rejected</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>,
          <span class="ruby-comment cmt"># These are search score attributes:</span>
          <span class="ruby-identifier">:xcorr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">xcorr</span>,
          <span class="ruby-identifier">:deltacn</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">deltacn</span>,
          <span class="ruby-identifier">:deltacnstar</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">deltacnstar</span>,
          <span class="ruby-identifier">:spscore</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">sp</span>,
          <span class="ruby-identifier">:sprank</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">rsp</span>,
          <span class="ruby-identifier">:modification_info</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">modifications_obj</span>.<span class="ruby-identifier">modification_info</span>(<span class="ruby-constant">SpecID</span><span class="ruby-operator">::</span><span class="ruby-constant">Pep</span>.<span class="ruby-identifier">split_sequence</span>(<span class="ruby-identifier">top_pep</span>.<span class="ruby-identifier">sequence</span>)[<span class="ruby-value">1</span>]),
          <span class="ruby-identifier">:spectrum_query</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">spec_query</span>,
        })
        <span class="ruby-identifier">search_result</span>.<span class="ruby-identifier">search_hits</span> = [<span class="ruby-identifier">search_hit</span>] <span class="ruby-comment cmt"># there can be multiple search hits</span>
        <span class="ruby-identifier">spec_query</span>.<span class="ruby-identifier">search_results</span> = [<span class="ruby-identifier">search_result</span>]  <span class="ruby-comment cmt"># can be multiple search_results</span>
        <span class="ruby-identifier">spec_query</span>
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-comment cmt"># create an index by spectrum as results end up typically in out2summary</span>
      <span class="ruby-comment cmt"># (I really dislike this order, however)</span>
      <span class="ruby-identifier">spectrum_queries_ar</span> = <span class="ruby-identifier">spectrum_queries_ar</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">pep</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pep</span>.<span class="ruby-identifier">spectrum</span> }
      <span class="ruby-identifier">spectrum_queries_ar</span>.<span class="ruby-identifier">each_with_index</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">res</span>,<span class="ruby-identifier">index</span><span class="ruby-operator">|</span> <span class="ruby-identifier">res</span>.<span class="ruby-identifier">index</span> = <span class="ruby-node">&quot;#{index + 1}&quot;</span> }
      <span class="ruby-identifier">pipeline</span>.<span class="ruby-identifier">msms_run_summary</span>.<span class="ruby-identifier">spectrum_queries</span> = <span class="ruby-identifier">spectrum_queries_ar</span>
      <span class="ruby-identifier">pepxml_obj</span>
    <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">## collects pepxml_objs</span>
    <span class="ruby-comment cmt"># summary_xml is the short basename of the pepxml file (e.g., &quot;020.xml&quot;)</span>
    <span class="ruby-identifier">pepxml_objects</span>.<span class="ruby-identifier">sort_by</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">summary_xml</span> }
  <span class="ruby-keyword kw">end</span></pre>
</body>
</html>